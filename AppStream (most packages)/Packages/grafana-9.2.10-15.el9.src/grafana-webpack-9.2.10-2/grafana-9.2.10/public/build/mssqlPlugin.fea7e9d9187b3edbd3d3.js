(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5032],{15679:(e,t,a)=>{"use strict";a.r(t),a.d(t,{plugin:()=>H});var n=a(28594),s=a(4640),i=a(77813),r=(a(76687),a(68786)),l=a(27668),o=a(72660),c=a(50385),d=a(9120),u=a(62533),h=a(23277),m=a(96845),p=a(46286),f=a(35562),b=a(76290);let v,g;!function(e){e.sqlAuth="SQL Server Authentication",e.windowsAuth="Windows Authentication"}(v||(v={})),function(e){e.disable="disable",e.false="false",e.true="true"}(g||(g={}));var y,S,x,w,j,L,A,E,T=a(52010);function C(e){return{ulPadding:(0,i.css)({margin:e.spacing(1,0),paddingLeft:e.spacing(5)})}}var D=a(55534),M=a(49410);var q=a(33963);function I(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}class R{constructor(e,t,a){I(this,"target",void 0),I(this,"templateSrv",void 0),I(this,"scopedVars",void 0),this.target=(0,q.Y)(e||{refId:"A"}),this.templateSrv=t,this.scopedVars=a}quoteLiteral(e){return"'"+e.replace(/'/g,"''")+"'"}}var _=a(86832);class O{transformMetricFindResponse(e){const t=[],a=e.fields.find((e=>"__text"===e.name)),n=e.fields.find((e=>"__value"===e.name));if(a&&n)for(let e=0;e<a.values.length;e++)t.push({text:""+a.values.get(e),value:""+n.values.get(e)});else t.push(...e.fields.flatMap((e=>e.values.toArray())).map((e=>({text:e}))));return(0,_.uniqBy)(t,"text")}}var F=a(95129);const P=e=>{let{getColumns:t,getTables:a}=e;return(e,n)=>Object.assign({},n&&(0,F.getStandardSQLCompletionProvider)(e,n),{tables:{resolve:async e=>await a.current(e.table),parseName:e=>{if(!e)return{table:""};let t=e,a=t.value;for(;t.next&&t.next.type!==F.TokenType.Whitespace;)a+=t.next.value,t=t.next;return t.value.endsWith(".")&&(a=t.value.slice(0,t.value.length-1)),{table:a}}},columns:{resolve:async e=>{if(null==e||!e.table)return[];const[a,n,s]=e.table.split(".");return await t.current({table:`${n}.${s}`,dataset:a,refId:"A"})}}})};var W=a(12799);function N(e){switch(e){case"datetimeoffset":case"date":case"datetime2":case"smalldatetime":case"datetime":case"time":return"clock-nine";case"bit":return"toggle-off";case"tinyint":case"smallint":case"int":case"bigint":case"decimal":case"numeric":case"real":case"float":case"money":case"smallmoney":return"calculator-alt";case"char":case"varchar":case"text":case"nchar":case"nvarchar":case"ntext":case"binary":case"varbinary":case"image":return"text";default:return}}function B(e){switch(e){case"datetimeoffset":case"datetime2":case"smalldatetime":case"datetime":return"datetime";case"time":return"time";case"date":return"date";case"bit":return"boolean";case"tinyint":case"smallint":case"int":case"bigint":case"decimal":case"numeric":case"real":case"float":case"money":case"smallmoney":return"number";default:return"text"}}function k(e){var t,a,n,s;let{sql:i,dataset:r,table:l}=e,o="";if(!i||!(0,W.IC)(i.columns))return o;if(o+=function(e,t){const a=e.map((e=>{let t="";var a,n;e.name?t+=`${e.name}(${null===(a=e.parameters)||void 0===a?void 0:a.map((e=>`${e.name}`))})`:t+=`${null===(n=e.parameters)||void 0===n?void 0:n.map((e=>`${e.name}`))}`;return t}));return`SELECT ${$(t)?"TOP("+t+")":""} ${a.join(", ")} `}(i.columns,i.limit),r&&l&&(o+=`FROM ${r}.${l} `),i.whereString&&(o+=`WHERE ${i.whereString} `),null!==(t=i.groupBy)&&void 0!==t&&null!==(a=t[0])&&void 0!==a&&a.property.name){o+=`GROUP BY ${i.groupBy.map((e=>e.property.name)).filter((e=>!(0,_.isEmpty)(e))).join(", ")} `}return null!==(n=i.orderBy)&&void 0!==n&&n.property.name&&(o+=`ORDER BY ${i.orderBy.property.name} `),null!==(s=i.orderBy)&&void 0!==s&&s.property.name&&i.orderByDirection&&(o+=`${i.orderByDirection} `),o}const $=e=>void 0!==e&&e>=0;class Q extends D.D{constructor(e){var t,a,n;super(e),n=void 0,(a="sqlLanguageDefinition")in(t=this)?Object.defineProperty(t,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[a]=n}getQueryModel(e,t,a){return new R(e,t,a)}getResponseParser(){return new O}async fetchDatasets(){return(await this.runSql("SELECT name FROM sys.databases WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb');",{refId:"datasets"})).fields.name.values.toArray().flat()}async fetchTables(e){var t;return(await this.runSql((t=e,`SELECT TABLE_SCHEMA + '.' + TABLE_NAME as schemaAndName\n    FROM [${t}].INFORMATION_SCHEMA.TABLES\n    WHERE TABLE_TYPE = 'BASE TABLE'`),{refId:"tables"})).fields.schemaAndName.values.toArray().flat()}async fetchFields(e){if(!e.table)return[];const[t,a]=e.table.split("."),n=await this.runSql(function(e,t){return`\n   USE ${e}\n   SELECT COLUMN_NAME as 'column',DATA_TYPE as 'type'\n   FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='${t}';`}(e.dataset,a),{refId:"columns"}),s=[];for(let e=0;e<n.length;e++){const t=n.fields.column.values.get(e),a=n.fields.type.values.get(e);s.push({label:t,value:t,type:a,icon:N(a),raqbFieldType:B(a)})}return s}getSqlLanguageDefinition(e){if(void 0!==this.sqlLanguageDefinition)return this.sqlLanguageDefinition;const t={getColumns:{current:t=>async function(e,t){const a=await e.fields(t);return a.length>0?a.map((e=>({name:e.value,type:e.value,description:e.value}))):[]}(e,t)},getTables:{current:t=>async function(e,t){var a;return await(null===(a=e.lookup)||void 0===a?void 0:a.call(e,t))||[]}(e,t)}};return this.sqlLanguageDefinition={id:"sql",completionProvider:P(t),formatter:M._},this.sqlLanguageDefinition}getDB(){return void 0!==this.db?this.db:{init:()=>Promise.resolve(!0),datasets:()=>this.fetchDatasets(),tables:e=>this.fetchTables(e),getEditorLanguageDefinition:()=>this.getSqlLanguageDefinition(this.db),fields:async e=>null!=e&&e.dataset&&null!=e&&e.table?this.fetchFields(e):[],validateQuery:e=>Promise.resolve({isError:!1,isValid:!0,query:e,error:"",rawSql:e.rawSql}),dsID:()=>this.id,dispose:e=>{},toRawSql:k,lookup:async e=>{if(e){const t=e.split(".").filter((e=>e));if(t.length>2)return[];if(1===t.length){return(await this.fetchTables(t[0])).map((e=>({name:e,completion:e})))}return[]}return(await this.fetchDatasets()).map((e=>({name:e,completion:`${e}.`})))}}}}const H=new n.hf(Q).setQueryEditor(s.M).setConfigEditor((e=>{const{options:t,onOptionsChange:a}=e,n=(0,l.wW)(C),s=t.jsonData,i=e=>n=>{a(Object.assign({},t,{[e]:n.currentTarget.value}))},D=[{value:v.sqlAuth,label:"SQL Server Authentication"},{value:v.windowsAuth,label:"Windows Authentication"}],M=[{value:g.disable,label:"disable"},{value:g.false,label:"false"},{value:g.true,label:"true"}],q=15;return(0,T.jsxs)(T.Fragment,{children:[(0,T.jsxs)(o.C,{label:"MS SQL Connection",width:400,children:[(0,T.jsx)(c._,{labelWidth:q,label:"Host",children:(0,T.jsx)(d.I,{width:46,name:"host",type:"text",value:t.url||"",placeholder:"localhost:1433",onChange:i("url")})}),(0,T.jsx)(c._,{labelWidth:q,label:"Database",children:(0,T.jsx)(d.I,{width:46,name:"database",value:t.database||"",placeholder:"database name",onChange:i("database")})}),(0,T.jsx)(c._,{label:"Authentication",labelWidth:q,htmlFor:"authenticationType",tooltip:(0,T.jsxs)("ul",{className:n.ulPadding,children:[y||(y=(0,T.jsxs)("li",{children:[(0,T.jsx)("i",{children:"SQL Server Authentication"})," This is the default mechanism to connect to MS SQL Server. Enter the SQL Server Authentication login or the Windows Authentication login in the DOMAIN\\User format."]})),S||(S=(0,T.jsxs)("li",{children:[(0,T.jsx)("i",{children:"Windows Authentication"})," Windows Integrated Security - single sign on for users who are already logged onto Windows and have enabled this option for MS SQL Server."]}))]}),children:(0,T.jsx)(u.Ph,{value:s.authenticationType||v.sqlAuth,inputId:"authenticationType",options:D,onChange:e=>{a(Object.assign({},t,{jsonData:Object.assign({},s,{authenticationType:e.value}),secureJsonData:Object.assign({},t.secureJsonData,{password:""}),secureJsonFields:Object.assign({},t.secureJsonFields,{password:!1}),user:""}))}})}),s.authenticationType===v.windowsAuth?null:(0,T.jsxs)(h.Z,{children:[(0,T.jsx)(c._,{labelWidth:q,label:"User",children:(0,T.jsx)(d.I,{width:q,value:t.user||"",placeholder:"user",onChange:i("user")})}),(0,T.jsx)(c._,{label:"Password",labelWidth:q,children:(0,T.jsx)(m.m4,{width:q,placeholder:"Password",isConfigured:t.secureJsonFields&&t.secureJsonFields.password,onReset:()=>{(0,r.Mf)(e,"password")},onBlur:(0,r.fi)(e,"password")})})]})]}),(0,T.jsxs)(o.C,{label:"TLS/SSL Auth",children:[(0,T.jsx)(c._,{labelWidth:25,htmlFor:"encrypt",tooltip:(0,T.jsxs)(T.Fragment,{children:["Determines whether or to which extent a secure SSL TCP/IP connection will be negotiated with the server.",(0,T.jsxs)("ul",{className:n.ulPadding,children:[x||(x=(0,T.jsxs)("li",{children:[(0,T.jsx)("i",{children:"disable"})," - Data sent between client and server is not encrypted."]})),w||(w=(0,T.jsxs)("li",{children:[(0,T.jsx)("i",{children:"false"})," - Data sent between client and server is not encrypted beyond the login packet. (default)"]})),j||(j=(0,T.jsxs)("li",{children:[(0,T.jsx)("i",{children:"true"})," - Data sent between client and server is encrypted."]}))]}),"If you're using an older version of Microsoft SQL Server like 2008 and 2008R2 you may need to disable encryption to be able to connect."]}),label:"Encrypt",children:(0,T.jsx)(u.Ph,{options:M,value:s.encrypt||g.disable,inputId:"encrypt",onChange:t=>{(0,r.tp)(e,"encrypt",t.value)}})}),s.encrypt===g.true?(0,T.jsxs)(T.Fragment,{children:[(0,T.jsx)(c._,{labelWidth:25,htmlFor:"skipTlsVerify",label:"Skip TLS Verify",children:(0,T.jsx)(p.x,{id:"skipTlsVerify",onChange:t=>{(0,r.tp)(e,"tlsSkipVerify",t.currentTarget.checked)},value:s.tlsSkipVerify||!1})}),s.tlsSkipVerify?null:(0,T.jsxs)(T.Fragment,{children:[(0,T.jsx)(c._,{labelWidth:25,tooltip:L||(L=(0,T.jsx)("span",{children:"Path to file containing the public key certificate of the CA that signed the SQL Server certificate. Needed when the server certificate is self signed."})),label:"TLS/SSL Root Certificate",children:(0,T.jsx)(d.I,{value:s.sslRootCertFile||"",onChange:(0,r._R)(e,"sslRootCertFile"),placeholder:"TLS/SSL root certificate file path"})}),(0,T.jsx)(c._,{labelWidth:25,label:"Hostname in server certificate",children:(0,T.jsx)(d.I,{placeholder:"Common Name (CN) in server certificate",value:s.serverName||"",onChange:(0,r._R)(e,"serverName")})})]})]}):null]}),(0,T.jsx)(b.K,{labelWidth:q,jsonData:s,onPropertyChanged:(t,a)=>{(0,r.tp)(e,t,a)}}),(0,T.jsx)(o.C,{label:"MS SQL details",children:(0,T.jsx)(c._,{tooltip:A||(A=(0,T.jsxs)("span",{children:["A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example",(0,T.jsx)("code",{children:"1m"})," if your data is written every minute."]})),label:"Min time interval",children:(0,T.jsx)(d.I,{placeholder:"1m",value:s.timeInterval||"",onChange:(0,r._R)(e,"timeInterval")})})}),E||(E=(0,T.jsxs)(f.b,{title:"User Permission",severity:"info",children:["The database user should only be granted SELECT permissions on the specified database and tables you want to query. Grafana does not validate that queries are safe so queries can contain any SQL statement. For example, statements like ",(0,T.jsx)("code",{children:"USE otherdb;"})," and ",(0,T.jsx)("code",{children:"DROP TABLE user;"})," would be executed. To protect against this we ",(0,T.jsx)("em",{children:"highly"})," recommmend you create a specific MS SQL user with restricted permissions."]}))]})}))},20770:()=>{},58228:()=>{}}]);
//# sourceMappingURL=mssqlPlugin.fea7e9d9187b3edbd3d3.js.map