From 636dbbfd795583431523972a0057ede74d110a6e Mon Sep 17 00:00:00 2001
Message-ID: <636dbbfd795583431523972a0057ede74d110a6e.1707394627.git.jdenemar@redhat.com>
From: Peter Krempa <pkrempa@redhat.com>
Date: Wed, 24 Jan 2024 17:13:51 +0100
Subject: [PATCH] virpcivpdtest: testPCIVPDResourceBasic: Remove tests for
 uninitialized 'ro'/'rw' section
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This is a synthetic case which tests the behaviour if the 'ro' or 'rw'
struct members are uninitialized, basically excercising only a pointless
programming-error NULL check in 'virPCIVPDResourceUpdateKeyword' as real
usage does always pass a proper pointer.

Signed-off-by: Peter Krempa <pkrempa@redhat.com>
Reviewed-by: JÃ¡n Tomko <jtomko@redhat.com>
(cherry picked from commit e8f5edf556145cbe6bae53255ded3051d65f24f1)

https://issues.redhat.com/browse/RHEL-22314 [9.4.0]
---
 tests/virpcivpdtest.c | 27 ---------------------------
 1 file changed, 27 deletions(-)

diff --git a/tests/virpcivpdtest.c b/tests/virpcivpdtest.c
index 8a2f337e85..20545759d5 100644
--- a/tests/virpcivpdtest.c
+++ b/tests/virpcivpdtest.c
@@ -64,11 +64,6 @@ testPCIVPDResourceBasic(const void *data G_GNUC_UNUSED)
         {.keyword = "SN", .value = "serial2", .actual = &ro->serial_number},
         {.keyword = "serial_number", .value = "serial3", .actual = &ro->serial_number},
     };
-    const TestPCIVPDKeywordValue readWriteCases[] = {
-        {.keyword = "YA", .value = "tag1", .actual = &ro->change_level},
-        {.keyword = "YA", .value = "tag2", .actual = &ro->change_level},
-        {.keyword = "asset_tag", .value = "tag3", .actual = &ro->change_level},
-    };
     const TestPCIVPDKeywordValue unsupportedFieldCases[] = {
         {.keyword = "FG", .value = "42", .actual = NULL},
         {.keyword = "LC", .value = "42", .actual = NULL},
@@ -77,7 +72,6 @@ testPCIVPDResourceBasic(const void *data G_GNUC_UNUSED)
         {.keyword = "EX", .value = "42", .actual = NULL},
     };
     size_t numROCases = G_N_ELEMENTS(readOnlyCases);
-    size_t numRWCases = G_N_ELEMENTS(readWriteCases);
     size_t numUnsupportedCases = G_N_ELEMENTS(unsupportedFieldCases);
     g_autoptr(virPCIVPDResource) res = g_new0(virPCIVPDResource, 1);
     virPCIVPDResourceCustom *custom = NULL;
@@ -85,20 +79,6 @@ testPCIVPDResourceBasic(const void *data G_GNUC_UNUSED)
     g_autofree char *val = g_strdup("testval");
     res->name = g_steal_pointer(&val);
 
-    /* RO has not been initialized - make sure updates fail. */
-    for (i = 0; i < numROCases; ++i) {
-        if (virPCIVPDResourceUpdateKeyword(res, true,
-                                           readOnlyCases[i].keyword,
-                                           readOnlyCases[i].value))
-            return -1;
-    }
-    /* RW has not been initialized - make sure updates fail. */
-    for (i = 0; i < numRWCases; ++i) {
-        if (virPCIVPDResourceUpdateKeyword(res, false,
-                                           readWriteCases[i].keyword,
-                                           readWriteCases[i].value))
-            return -1;
-    }
     /* Initialize RO */
     res->ro = g_steal_pointer(&ro);
 
@@ -131,13 +111,6 @@ testPCIVPDResourceBasic(const void *data G_GNUC_UNUSED)
             return -1;
     }
 
-    /* Check that RW updates fail if RW has not been initialized. */
-    if (virPCIVPDResourceUpdateKeyword(res, false, "YA", "tag1"))
-        return -1;
-
-    if (virPCIVPDResourceUpdateKeyword(res, false, "asset_tag", "tag1"))
-        return -1;
-
     /* Initialize RW */
     res->rw = g_steal_pointer(&rw);
     if (!virPCIVPDResourceUpdateKeyword(res, false, "YA", "tag1")
-- 
2.43.0
